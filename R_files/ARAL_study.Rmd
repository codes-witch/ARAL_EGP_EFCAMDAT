---
title: "TODO paper title"
output:
  pdf_document: default
  html_notebook: default
---


## Preparing the environment

```{r}
setwd("/home/daniela/Documents/ARAL_EGP_EFCAMDAT/R_files/")
source("/home/daniela/Documents/ARAL_EGP_EFCAMDAT/R_files/functions.R")
library(ggplot2)
library(gridExtra)
library("dplyr")
library("stringr")
library(tidyr)
library(tools)
library(knitr)
library("tidytext")
load("/home/daniela/Documents/ARAL_EGP_EFCAMDAT/R_files/ef2_20181231.RData")
all_features <- readLines("all_features.txt")
```

First, I we get rid of all texts that have not achieved the passing grade of X (TODO)
```{r}
# passing_grade <- 80 #TODO change?

# head(ef2)
# ef2_filtered <- ef2[ef2$grade >= passing_grade, ]

# nrow(ef2)
```

We are left with 832810 texts. Now, we add a column with the CEFR level that each text should belong to based on the EFCAMDAT level

```{r}
# rename the "level" column (which is at index 2)
colnames(ef2)[2] <- "ef_level"
# remove unnecessary colums
ef2 <- ef2[, !colnames(ef2) %in% c("text", "corrected")]
# add cefr level
ef2_prepared <- add_cefr_from_ef_levels(ef2)

# mark those rows with the first and last units of a CEFR level
# This will help us group them
ef2_prepared <- add_combined_level(ef2_prepared)
```

Now, get the learnerIDs of people who have finished their respective CEFR levels

```{r}
# Get those students that completed each level
# (except C2, for which we only need the students who completed the first three units)
cefr_ef_lvls <- list(
  "A1" = c(1:3),
  "A2" = c(4:6),
  "B1" = c(7:9),
  "B2" = c(10:12),
  "C1" = c(13:15),
  "C2" = c(16)
)

list_students_finsihed <- list()


for (cur_cefr_lvl in names(cefr_ef_lvls)) {
  if (cur_cefr_lvl != "C2") {
    learners_finished <- ef2_prepared %>%
      filter(ef_level == last(cefr_ef_lvls[[cur_cefr_lvl]]) & unit == 8) %>% # Only rows of the last unit of last EF level of CEFR level}
      pull(unique(learnerID))
  } else {
    learners_finished <- ef2_prepared %>%
      filter(ef_level == last(cefr_ef_lvls[[cur_cefr_lvl]]) & unit == 3) %>% # Only rows of those who started C2 (and did at least until unit 3)
      pull(unique(learnerID))
  }

  list_students_finsihed[[cur_cefr_lvl]] <- learners_finished
}

# Check how many students we have for each level:
for (lvl in names(list_students_finsihed)) {
  print(paste(lvl, length(list_students_finsihed[[lvl]])))
}
```

We now know that in order to have a balanced sample, we can have at most 75 students of any given level in the combined CEFR levels.
Namely, each combined class will have 75 students from the lower level and 75 students from the higher level.

From the learners who completed the levels, we must sample 75 without replacement.
These people's texts in the first and last three units of their CEFR levels will be the ones to be analyzed.
In total, at each combined level we will have scripts written by 150 students and we will use them as a "snapshot" of their proficiency once the lower level reached.

Now, we must sample the students and extract their texts to be analyzed by the POLKE tool.

```{r}

```
